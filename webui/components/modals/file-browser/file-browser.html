<html>
<head>
  <title>File Browser</title>
  <script type="module">
    import { store } from "/components/modals/file-browser/file-browser-store.js";
  </script>
</head>
<body>
  <div x-data>
    <template x-if="$store.fileBrowser">
      <div class="file-browser-root">
        
        <!-- Loading State -->
        <div x-show="$store.fileBrowser.isLoading" class="loading-state">
          <div class="loading-spinner"></div>
          <p>Loading files...</p>
        </div>
        
        <!-- File Browser Content -->
        <div x-show="!$store.fileBrowser.isLoading" class="file-browser-content">
                <!-- Path navigator -->
              <div class="path-navigator">
                <button class="text-button back-button" @click="$store.fileBrowser.navigateUp()" aria-label="Navigate Up">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10.5 15">
                    <path d="m.75,5.25L5.25.75m0,0l4.5,4.5M5.25.75v13.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" />
                  </svg>
                  Up
                </button>
                <div id="current-path"><span id="path-text" x-text="$store.fileBrowser.browser.currentPath"></span></div>
              </div>

              <!-- Files list -->
              <div class="files-list">
                <div class="file-header">
                  <div class="file-cell" @click="$store.fileBrowser.toggleSort('name')">Name <span x-show="$store.fileBrowser.browser.sortBy === 'name'" x-text="$store.fileBrowser.browser.sortDirection === 'asc' ? '↑' : '↓'"></span></div>
                  <div class="file-cell-size" @click="$store.fileBrowser.toggleSort('size')">Size <span x-show="$store.fileBrowser.browser.sortBy === 'size'" x-text="$store.fileBrowser.browser.sortDirection === 'asc' ? '↑' : '↓'"></span></div>
                  <div class="file-cell-date" @click="$store.fileBrowser.toggleSort('date')">Modified <span x-show="$store.fileBrowser.browser.sortBy === 'date'" x-text="$store.fileBrowser.browser.sortDirection === 'asc' ? '↑' : '↓'"></span></div>
                </div>

                <!-- File list entries -->
                <template x-if="$store.fileBrowser.browser.entries.length">
                  <template x-for="file in $store.fileBrowser.sortFiles($store.fileBrowser.browser.entries)" :key="file.path">
                    <div class="file-item" :data-is-dir="file.is_dir">
                      <div class="file-name" @click="file.is_dir ? $store.fileBrowser.navigateToFolder(file.path) : $store.fileBrowser.downloadFile(file)">
                        <img :src="'/public/' + (file.type === 'unknown' ? 'file' : ($store.fileBrowser.isArchive(file.name) ? 'archive' : file.type)) + '.svg'" class="file-icon" :alt="file.type" />
                        <span x-text="file.name"></span>
                      </div>
                      <div class="file-size" x-text="$store.fileBrowser.formatFileSize(file.size)"></div>
                      <div class="file-date" x-text="$store.fileBrowser.formatDate(file.modified)"></div>
                      <div class="file-actions">
                        <!-- More actions dropdown -->
                        <div class="dropdown" x-data="{ open: false }" @click.outside="open = false">
                          <button class="btn-icon-action" @click.stop="open = !open" title="More actions">
                            <span class="material-symbols-outlined">more_vert</span>
                          </button>
                          <div class="dropdown-menu" x-show="open" x-transition.opacity>
                            <button class="dropdown-item" x-show="!file.is_dir" @click.stop="$store.fileBrowser.openEdit(file); open = false">
                              <span class="material-symbols-outlined">edit</span>
                              Edit
                            </button>
                            <button class="dropdown-item" @click.stop="$store.fileBrowser.openRename(file); open = false">
                              <span class="material-symbols-outlined">drive_file_rename_outline</span>
                              Rename
                            </button>
                          </div>
                        </div>
                        <button class="btn-icon-action" @click.stop="$store.fileBrowser.downloadFile(file)" title="Download file">
                          <span class="material-symbols-outlined">download</span>
                        </button>
                        <button class="btn-icon-action" @click.stop="$confirmClick($event, () => $store.fileBrowser.deleteFile(file))" title="Delete file">
                          <span class="material-symbols-outlined">delete</span>
                        </button>
                      </div>
                    </div>
                  </template>
                </template>

                <!-- Empty state -->
                <template x-if="!$store.fileBrowser.browser.entries.length">
                  <div class="no-files">No files found</div>
                </template>
              </div>
            </div>
        </div>
        
      </div>
    </template>
    
    <!-- Modal Footer (outside template x-if so it exists immediately) -->
    <template x-if="$store.fileBrowser">
      <div class="modal-footer" data-modal-footer x-data="{ uploadInput: null }" x-init="uploadInput = $refs.uploadInput">
        <button class="btn btn-footer-action" @click="$store.fileBrowser.openNewFile()" title="New File">
          <span class="material-symbols-outlined">note_add</span>
          <span class="btn-text">New File</span>
        </button>
        <button class="btn btn-footer-action" @click="$store.fileBrowser.openNewFolder()" title="New Folder">
          <span class="material-symbols-outlined">create_new_folder</span>
          <span class="btn-text">New Folder</span>
        </button>
        <button class="btn btn-footer-action" @click="$refs.uploadInput.click()" title="Upload Files">
          <span class="material-symbols-outlined">upload</span>
          <span class="btn-text">Upload  Files</span>
        </button>
        <input x-ref="uploadInput" type="file" multiple accept="*" @change="$store.fileBrowser.handleFileUpload" style="display:none;" />
        <button class="btn btn-cancel" @click="$store.fileBrowser.handleClose()">Close</button>
      </div>
    </template>
  </div>

  <!-- Confirm Dialog Template -->
  <template id="confirm-dialog-template">
    <div class="confirm-dialog-overlay">
      <div class="confirm-dialog">
        <div class="confirm-dialog-title"></div>
        <div class="confirm-dialog-message"></div>
        <div class="confirm-dialog-buttons">
          <button class="btn btn-cancel confirm-btn-cancel">Cancel</button>
          <button class="btn btn-ok confirm-btn-ok">Discard</button>
        </div>
      </div>
    </div>
  </template>

  <style>
    /* File Browser Root */
    .file-browser-root {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    /* Loading State */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-lg);
      min-height: 200px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top: 3px solid var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-md);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-state p {
      color: var(--color-text-secondary);
      margin: 0;
    }

    /* File Browser Content */
    .file-browser-content {
      display: flex;
      flex-direction: column;
      padding: var(--spacing-sm) var(--spacing-sm);
    }

    /* File Browser Styles */
    .files-list {
      width: 100%;
      border-radius: 4px;
    }
    .file-header {
      width: 100%;
      border-radius: 4px;
      overflow: hidden;
    }
    .file-item {
      width: 100%;
      border-radius: 4px;
      position: relative;
    }

    /* Header Styles */
    .file-header {
    display: grid;
    grid-template-columns: 1.5fr 0.5fr 0.8fr 100px;
    background: var(--secondary-bg);
    padding: 8px 0;
    font-weight: bold;
    border-bottom: 1px solid var(--border-color);
    color: var(--color-primary);
    }
    .file-cell,
    .file-cell-size,
    .file-cell-date {
    color: var(--color-primary);
    padding: 4px;
    cursor: pointer;
    }

    /* File Item Styles */
    .file-item {
    display: grid;
    grid-template-columns: 1.5fr 0.5fr 0.8fr 100px;
    align-items: center;
    padding: 8px 0;
    font-size: 0.875rem;
    border-top: 1px solid var(--color-border);
    transition: background-color 0.2s;
    white-space: nowrap;
    color: var(--color-text);
    position: relative;
    }
    .file-item:hover {
    background-color: var(--color-secondary);
    }

    /* File Icon and Name */
    .file-icon {
    width: 1.8rem;
    height: 1.8rem;
    margin: 0 1rem 0 0.7rem;
    vertical-align: middle;
    font-size: var(--font-size-sm);
    }
    .file-name {
    display: flex;
    align-items: center;
    font-weight: 500;
    margin-right: var(--spacing-sm);
    overflow: hidden;
    }
    .file-name > span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    }
    .file-size,
    .file-date {
    color: var(--text-secondary);
    }
    /* No Files Message */
    .no-files {
    padding: 32px;
    text-align: center;
    color: var(--text-secondary);
    }
    /* Light Mode Adjustments */
    .light-mode .file-item:hover {
    background-color: var(--color-secondary-light);
    }

    /* Path Navigator Styles */
    .path-navigator {
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 24px;
    background-color: var(--color-message-bg);
    padding: 0.5rem var(--spacing-sm);
    margin: 0 0 var(--spacing-sm) 0;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    }
    .nav-button {
    padding: 4px 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-background);
    color: var(--color-text);
    cursor: pointer;
    transition: background-color 0.2s;
    }
    .nav-button:hover {
    background: var(--hover-bg);
    }
    .nav-button.back-button {
    background-color: var(--color-secondary);
    color: var(--color-text);
    }
    .nav-button.back-button:hover {
    background-color: var(--color-secondary-dark);
    }
    #current-path {
    opacity: 0.9;
    }
    #path-text {
    font-family: 'Roboto Mono', monospace;
    -webkit-font-optical-sizing: auto;
    font-optical-sizing: auto;
    opacity: 0.9;
    }

    /* Folder Specific Styles */
    .file-item[data-is-dir="true"] {
    cursor: pointer;
    }
    .file-item[data-is-dir="true"]:hover {
    background-color: var(--color-secondary);
    }

    /* Footer Action Button */
    .btn-footer-action {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.45rem 1rem;
      background: #4248f1;
      color: white;
      border-radius: 0.25rem;
      cursor: pointer;
      transition: background-color 0.3s ease-in-out;
    }
    .btn-footer-action:hover {
      background-color: #353bc5;
    }
    .btn-footer-action:active {
      background-color: #2b309c;
    }

    @media (max-width: 540px) {
      .btn-footer-action .btn-text {
        display: none;
      }
    }

    /* Dropdown Menu */
    .file-actions .dropdown-menu {
      z-index: 100;
      min-width: 120px;
    }

    /* File Actions */
    .file-actions {
      display: flex;
      gap: var(--spacing-xs);
      flex-shrink: 0;
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .file-header,
      .file-item {
        grid-template-columns: 1fr 0.5fr 100px;
      }
      .file-cell-date,
      .file-date {
        display: none;
      }
    }
    @media (max-width: 540px) {
      .file-header,
      .file-item {
        grid-template-columns: 1fr 100px;
      }
      .file-cell-size,
      .file-size,
      .file-cell-date,
      .file-date {
        display: none;
      }
      .file-name {
        min-width: 0;
      }
    }

    /* Confirm Dialog */
    .confirm-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .confirm-dialog {
      background-color: var(--color-background);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      padding: 1.5rem;
      min-width: 300px;
      max-width: 400px;
      animation: confirm-dialog-enter 0.15s ease-out;
    }
    @keyframes confirm-dialog-enter {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .confirm-dialog-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 0.75rem;
    }
    .confirm-dialog-message {
      font-size: 0.9375rem;
      color: var(--color-text-secondary);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .confirm-dialog-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    .confirm-dialog-buttons .btn {
      min-width: 80px;
    }
    .confirm-dialog-buttons .confirm-btn-ok {
      background-color: var(--color-error, #e74c3c);
      border-color: var(--color-error, #e74c3c);
    }
    .confirm-dialog-buttons .confirm-btn-ok:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }
  </style>
</body>
</html>
